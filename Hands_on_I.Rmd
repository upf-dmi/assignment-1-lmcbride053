---
title: "Albert y Liam First Assignment"
author: "Liam McBride (liam.mcbride01@estudiant.upf.com)"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`"      
output:
  html_document:
    toc: true
    fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(stats)
library(DataExplorer)
library(outliers)
library(readxl)
```


# Analysis of the Heart Disease Dataset 
Load the data from
[here](https://raw.githubusercontent.com/jpinero/DMI_2021/main/datasets/heart_disease_dataset.csv), and the description is [here](https://raw.githubusercontent.com/jpinero/DMI_2021/main/datasets/heart_disease_description.txt). 
The original dataset comes from [here](https://archive.ics.uci.edu/ml/datasets/Heart+Disease) and corresponds to the [processed cleveland data](https://archive.ics.uci.edu/ml/machine-learning-databases/heart-disease/processed.cleveland.data)

## Perform an EDA on the dataset

### Reading in the Data
```{r}
hdisease <- read.table("./data/heart_disease_dataset.csv", header=T)
```

### Transforming the data to ensure categorical and numerical variables are treated as such

```{r}
hdisease1 <- hdisease %>%
  mutate(
    sex = ifelse(sex == 1, "male", "female"),
    cp = recode(cp, `1` = "typical angina", `2` = "atypical angina", `3` = "non-anginal pain", `4` = "asymptomatic"),
    fbs = ifelse(fbs == 1, T, F ),
    restecg = recode(restecg, `1` = "abnormal", `2` = "probable hypertrophy", `0` = "normal"),
    exang = ifelse(exang == 1, "yes", "no"),
    slope = recode(slope, `1` = "upsloping", `2` = "flat", `3` = "downsloping"),
    thal = recode(thal, `3` = "normal", `6` = "fixed defect", `7` = "reversible defect"),
    num = ifelse(num == 0, "negative diagnosis", "positive diagnosis")
  )
hdisease1[hdisease1 == "?"] <- NA

is_numeric <- sapply(hdisease1, is.numeric)
min_percentile_thresholds <- numeric(sum(is_numeric))
max_percentile_thresholds <- numeric(sum(is_numeric))
# Loop through each numeric column to detect and replace outliers
for (i in which(is_numeric)) {
  column_data <- hdisease1[[i]]
  min_percentile_thresholds[i] <- quantile(hdisease1[[i]], 0.05, na.rm = TRUE)  # 5th percentile
  max_percentile_thresholds[i] <- quantile(hdisease1[[i]], 0.95, na.rm = TRUE)  # 95th percentile
  hdisease1[[i]][column_data < min_percentile_thresholds[i]] <- min_percentile_thresholds[i] 
  hdisease1[[i]][column_data > max_percentile_thresholds[i]] <- max_percentile_thresholds[i]
}

```

### Summary of the data
```{r}
summary(hdisease1)
```
### Age distribution
```{r}
ggplot(hdisease1, aes(x=age)) +
  geom_histogram()
```

```{r}
plot_missing(hdisease1)
```

### Distributions of numerical variables
```{r}
numeric_vars <- hdisease1 %>%
  select_if(is.numeric) %>%
  select(!patient_id)

# Plot histograms for selected variables
numeric_vars %>%
  gather(key = "variable", value = "value") %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 10, fill = "blue", color = "black", alpha = 0.7) +
  facet_wrap(~ variable, scales = "free_x") +
  theme_minimal() +
  labs(title = "Histograms of Numerical Variables", x = "Value", y = "Frequency")
```

```{r}
numeric_vars %>%
  gather(key = "variable", value = "value") %>%
  ggplot(aes(x = value)) +
  geom_boxplot() +
  facet_wrap(~ variable, scales = "free_x") +
  theme_minimal() +
  labs(title = "Boxplots of Numerical Variables", x = "Value", y = "Frequency")
```

### Distributions of categorical variables
```{r}
# Select categorical variables
categorical_vars <- hdisease1 %>%
  select_if(function(col) is.character(col) || is.logical(col))

# Convert the categorical variables to long format for plotting
categorical_vars_long <- categorical_vars %>%
  gather(key = "variable", value = "value")

# Plot bar charts for categorical variables
categorical_vars_long %>%
  ggplot(aes(x = value)) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  facet_wrap(~ variable, scales = "free_x") +
  theme_minimal() +
  labs(title = "Bar Charts of Categorical Variables", x = "Category", y = "Count")

categorical_vars_long %>%
  gather(key = "variable", value = "value") %>%
  count(variable, value) %>%
  arrange(variable, desc(n))
```


## Create visualizations in order to show which variables seem to be more associated with heart disease

```{r}

```


# 2 Difference in mortality rates in hospitalized COVID-19 patients 
Using the supplementary material from the [Difference in mortality rates in hospitalized COVID-19 patients identified by cytokine profile clustering using a machine learning approach: An outcome prediction alternative](https://www.frontiersin.org/articles/10.3389/fmed.2022.987182/full), perform the following tasks

## Reproduce Figure 1 from the publication

```{r}
Table1 <- read_excel("~/Documents/Table1.xlsx", skip = 1)
Table1$Group = NA
Table1 <- Table1 %>%
  mutate(Group = case_when(
    `ARDS Diagnosis` == "Yes" & `Use of AMV` == "Yes" & (`Use of NIV` == "Yes" | `Use of NIV` == "No") ~ 4,
    `ARDS Diagnosis` == "Yes" & `Use of AMV`== "No" & `Use of NIV` == "Yes" ~ 3,
    `ARDS Diagnosis` == "No" & (`Use of AMV` == "Yes" | `Use of AMV` == "No") & (`Use of NIV` == "Yes" | `Use of NIV` == "No") ~ 2,
    `ARDS Diagnosis` == "No" & `Use of AMV`== "No" & `Use of NIV` == "No" ~ 1
  ))
Table1 <- Table1 %>%
  distinct()
Table1 <- Table1 %>%
  filter(Death %in% c("Yes", "No"))
Table1 <- Table1 %>%
  count(ID) %>%
  filter(n == 1) %>%
  inner_join(Table1, by = "ID")
Table1 <- Table1 %>%
  filter(!is.na(Group))
```


## Reproduce Figure 2 from the publication
but instead of representing the clusters in the annotation, represent the groups (G1 to G4)

```{r}
library(pheatmap)

Table2 <- read_excel("~/Documents/Table2.xlsx", skip = 1)
names(Table2)[1] <- "ID"
Table2 <- Table2 %>%
  fill(ID, .direction = "down")
Table2 <- Table2 %>%
  left_join(Table1 %>% select(ID, Group), by = "ID")
Table2_clean <- Table2 %>%
  filter_all(all_vars(. != "NI"))
cytokine_data <- Table2_clean %>%
  select(c("Group", "IL-1β", "IL-6", "IL-10", "IFN-ɑ", "TNF-ɑ", "IL-8", "G-CSF", "IFN-γ", 
           "CCL3", "CXCL10", "CCL2", "IL-38"))

cytokine_data$Group <- as.factor(cytokine_data$Group)

# Convert cytokine columns to numeric (handles non-numeric values as NA)
cytokine_data[ , 2:ncol(cytokine_data)] <- lapply(cytokine_data[ , 2:ncol(cytokine_data)], as.numeric)

# Remove rows with NA values (optional, based on your data)
cytokine_data <- na.omit(cytokine_data)

# Extract the Group column as the annotation
annotation_row <- data.frame(Group = cytokine_data$Group)
rownames(annotation_row) <- rownames(cytokine_data)  # Ensure rownames match cytokine data

# Remove the Group column from the cytokine matrix
cytokine_matrix <- as.matrix(cytokine_data[, -1])
rownames(cytokine_matrix) <- rownames(cytokine_data)

# Scale the data row-wise for relative expression
cytokine_matrix <- scale(t(cytokine_matrix))

# Define colors for the groups
unique_groups <- levels(annotation_row$Group)  # Ensure proper levels of the Group factor
group_colors <- rainbow(length(unique_groups))  # Generate distinct colors for groups
names(group_colors) <- unique_groups

# Create annotation_colors list
annotation_colors <- list(Group = group_colors)
annotation_row <- t(annotation_row)
# Create the heatmap
heatmap(cytokine_matrix,
        scale = "none",  # Data is already scaled
        col = colorRampPalette(c("white", "orange", "brown"))(50),  # Color gradient
        main = "Cytokine Heatmap with Group Annotations",  # Title
        cexRow = 0.6, # Adjust cytokine label font size
        labCol = rep("", ncol(cytokine_matrix)),
        ColSideColors = group_colors[annotation_row],  # Add the group colors as side annotation
        margins = c(8, 10))  # Adjust margins to fit labels
```

## Improve figure 2 of the publication
Add a second annotation with information of death and a third one with information of gender

```{r}

```


# session info {.unnumbered}

```{r, results='asis',  echo=FALSE, message=FALSE }
sessionInfo()
```
